# psf-slp-db

[![js-standard-style](https://img.shields.io/badge/code%20style-standard-brightgreen.svg)](http://standardjs.com) [![semantic-release](https://img.shields.io/badge/%20%20%F0%9F%93%A6%F0%9F%9A%80-semantic--release-e10079.svg)](https://github.com/semantic-release/semantic-release)

## Overview

This is a REST API that provides access to a series of LevelDB instances. These Level databases are used to index SLP tokens on a blockchain. Each DB instance has a CRUD REST API for access by other applications.

The purpose of this code repository is to allow optimizations for parallel processing. By creating a REST API to these databases, multiple processes can access the same DB.

## Requirements

- node **^22.20.0**
- npm **^10.9.3**
- Docker **^24.0.7**
- Docker Compose **^1.27.4**

## Installation

### Production Environment

This app is included in the [psf-slp-indexer-g2](https://github.com/Permissionless-Software-Foundation/psf-slp-indexer-g2) production Docker containers. To run this app in production mode, follow the instructions in the README of that repository.

### Development Environment

A development environment will allow you modify the code on-the-fly and contribute to the code base of this repository. Ubuntu v20 is the recommended OS for creating a dev environment. Other operating systems may cause issues.

```bash
git clone https://github.com/Permissionless-Software-Foundation/psf-slp-db
cd psf-slp-db
./install-mongo-sh
npm install
npm start
```

### Configuration

This app is configured using environment variables. Copy the [.env-example](./.env-example) file to `.env` and modify the values as needed:

```bash
cp .env-example .env
```

The `.env` file is loaded automatically at startup. All configuration is defined in [config/env/common.js](./config/env/common.js).

#### Server

| Variable | Default | Description |
|---|---|---|
| `PORT` | `5020` | TCP port the REST API server listens on. |

#### Wallet

| Variable | Default | Description |
|---|---|---|
| `MNEMONIC` | *(empty)* | A 12-word BCH mnemonic used to generate encryption keys and a payment address. If set, the app will create a wallet from this mnemonic when no wallet file is found. |
| `WALLET_FILE` | `wallet.json` (project root) | Path to a wallet file generated by [psf-bch-wallet](https://github.com/Permissionless-Software-Foundation/psf-bch-wallet). If the file exists it will be used; otherwise a new wallet is created from `MNEMONIC`. |
| `WALLET_INTERFACE` | `web3` | Determines how the app connects to bch-api. Set to `web3` to connect via JSON RPC over IPFS. Set to `web2` to connect via a REST API over HTTP. |
| `APISERVER` | `https://api.fullstack.cash/v5/` (web2) / `https://free-bch.fullstack.cash/` (web3) | The bch-api server URL. When `WALLET_INTERFACE=web2`, this can be overridden to point to a custom REST API server. When `WALLET_INTERFACE=web3`, the value is always `https://free-bch.fullstack.cash/`. |
| `WALLET_AUTH_PASS` | *(empty)* | Basic authentication password for connecting to bch-api when using the `web2` wallet interface. Leave empty if authentication is not required. |

#### Admin & Backups

| Variable | Default | Description |
|---|---|---|
| `ADMIN_PASSWORD` | *(random)* | Password for the admin account. If not set, a random 20-character string is generated at startup. |
| `BACKUP_QTY` | `3` | Number of LevelDB backup zip files to retain. Older backups beyond this count are deleted. |
| `EXIT_ON_MISSING_BACKUP` | `false` | Controls behavior when the indexer is fully synced but a backup file is missing. Set to `true` to exit the process instead of rolling back to genesis. Any other value (or unset) will allow the rollback. |

#### SLP Token Blacklist

| Variable | Default | Description |
|---|---|---|
| `BLACKLIST` | *(empty)* | A comma-separated list of SLP token IDs that should be excluded from API responses. Example: `BLACKLIST=tokenId1,tokenId2,tokenId3`. |

## File Structure

The file layout of this repository follows the file layout of [Clean Architecture](https://christroutner.github.io/trouts-blog/blog/clean-architecture). Understaning the principles laid out this article will help developers navigate the code base.

## Usage

- `npm start` Start server on live mode
- `npm run docs` Generate API documentation
- `npm test` Run mocha tests

## Documentation

API documentation is written inline and generated by [apidoc](http://apidocjs.com/). Docs can be generated with this command:
- `npm run docs`

Visit `http://localhost:5020/` to view docs

There is additional developer documentation in the [dev-docs directory](./dev-docs).

## Dependencies

- [koa2](https://github.com/koajs/koa/tree/v2.x)
- [koa-router](https://github.com/alexmingoia/koa-router)
- [koa-bodyparser](https://github.com/koajs/bodyparser)
- [koa-generic-session](https://github.com/koajs/generic-session)
- [koa-logger](https://github.com/koajs/logger)
- [MongoDB](http://mongodb.org/)
- [Mongoose](http://mongoosejs.com/)
- [Passport](http://passportjs.org/)
- [Nodemon](http://nodemon.io/)
- [Mocha](https://mochajs.org/)
- [apidoc](http://apidocjs.com/)
- [ESLint](http://eslint.org/)
- [ipfs-coord](https://www.npmjs.com/package/ipfs-coord)

## License

[MIT](./LICENSE.md)
